name: deploy-docs

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history (required by mike)
          ref: master
          persist-credentials: true

      - name: ðŸ“¥ Fetch gh-pages branch
        run: |
          # Ensure we have the remote gh-pages branch locally so mike can update it safely
          git fetch origin gh-pages:gh-pages --depth=1 || echo "No existing gh-pages branch on remote"

      - name: ðŸ›‚ Configure Git credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ðŸ“¥ Install MkDocs and dependencies
        run: pip install --upgrade mkdocs mkdocs-material mkdocs-section-index mike

      - name: ðŸ§® Calculate cache ID
        run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV

      - name: ðŸ’¾ Restore pip cache
        uses: actions/cache@v4
        with:
          key: mkdocs-material-${{ env.cache_id }}
          path: .cache
          restore-keys: |
            mkdocs-material-

      - name: ðŸ§® Extract version from gradle.properties
        id: extract_version
        run: |
          version=$(grep "^version\s*=" gradle.properties | cut -d'=' -f2 | tr -d ' ')
          echo "VERSION=$version" >> $GITHUB_OUTPUT
          if [[ "$version" == *-SNAPSHOT ]]; then
            echo "IS_SNAPSHOT=true" >> $GITHUB_OUTPUT
          else
            echo "IS_SNAPSHOT=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Deploy documentation with mike
        run: |
          version=${{ steps.extract_version.outputs.VERSION }}
          is_snapshot=${{ steps.extract_version.outputs.IS_SNAPSHOT }}

          if [[ "$is_snapshot" == "true" ]]; then
            echo "Deploying SNAPSHOT to static folder 'snapshot'"
            mike deploy --push snapshot
          else
            echo "Deploying stable version $version with alias 'latest'"
            mike deploy --push --update-aliases "$version" latest
            mike set-default latest --push
          fi